package external

import (
	"testing"
)

var (
	validJson = `{"shipments":[{"states":[{"date":"2024-05-20T10:22:00Z","carrier":1,"status":"Overseas import customs clearance"},{"date":"2024-05-20T10:22:00Z","carrier":1,"status":"Departed from PT processing center"},{"date":"2024-05-20T10:22:00+00:00","carrier":2,"status":"Overseas import customs clearance"},{"date":"2024-05-20T10:22:00+00:00","carrier":2,"status":"Departed from 【PT】处理中心"},{"date":"2024-05-09T07:33:00Z","carrier":1,"status":"Customs retention for overseas import (waiting for supplementary documents)"},{"date":"2024-05-09T07:33:00+00:00","carrier":2,"status":"境外进口海关留存待验（等待补充文件）"},{"date":"2024-05-07T18:21:00Z","carrier":1,"status":"Entregue para liberação aduaneira de importação"},{"date":"2024-05-07T18:21:00+00:00","carrier":2,"status":"Handed over for import customs clearance"},{"date":"2024-05-07T18:19:00Z","carrier":1,"status":"Chegou ao centro de processamento"},{"date":"2024-05-07T18:19:00+00:00","carrier":2,"status":"Arrive at processing center"},{"date":"2024-05-07T16:47:00Z","carrier":1,"status":"Chegou ao local de destino"},{"date":"2024-05-07T16:47:00+00:00","carrier":2,"status":"Arrive at the place of destination"},{"date":"2024-05-07T16:16:00Z","carrier":1,"status":"Em trânsito"},{"date":"2024-05-07T16:16:00+00:00","carrier":2,"status":"In transit"},{"date":"2024-05-07T15:33:00Z","carrier":1,"status":"O avião pousou"},{"date":"2024-05-07T15:33:00+00:00","carrier":2,"status":"Plane has landed"},{"date":"2024-05-07T12:24:00Z","carrier":1,"status":"Partida da companhia aérea"},{"date":"2024-05-07T12:24:00+00:00","carrier":2,"status":"Airline departure"},{"date":"2024-05-06T07:27:00Z","carrier":1,"status":"Em trânsito"},{"date":"2024-05-06T07:27:00+00:00","carrier":2,"status":"In transit"},{"date":"2024-05-06T05:43:00Z","carrier":1,"status":"O avião pousou"},{"date":"2024-05-06T05:43:00+00:00","carrier":2,"status":"Plane has landed"},{"date":"2024-05-05T22:38:00Z","carrier":1,"status":"Partida da companhia aérea"},{"date":"2024-05-05T22:38:00+00:00","carrier":2,"status":"Airline departure"},{"date":"2024-05-04T16:30:00Z","carrier":1,"status":"Recebido pela companhia aérea"},{"date":"2024-05-04T16:30:00+00:00","carrier":2,"status":"Received by airline"},{"location":"Guangzhou, Guangdong","date":"2024-05-03T10:51:00Z","carrier":1,"status":"Handed over to the carrier for transportation"},{"location":"Guangzhou, Guangdong","date":"2024-05-03T10:51:00+00:00","carrier":2,"status":"Handed over to the carrier for transportation"},{"location":"Guangzhou, Guangdong","date":"2024-05-03T03:46:00Z","carrier":1,"status":"Departed from sorting center"},{"location":"Guangzhou, Guangdong","date":"2024-05-03T03:46:00+00:00","carrier":2,"status":"Departed from sorting center"},{"location":"Guangzhou, Guangdong","date":"2024-05-03T01:44:00Z","carrier":1,"status":"Sent to export customs"},{"location":"Guangzhou, Guangdong","date":"2024-05-03T01:44:00Z","carrier":1,"status":"Exported"},{"location":"Guangzhou, Guangdong","date":"2024-05-03T01:44:00Z","carrier":1,"status":"Export customs release"},{"location":"Guangzhou, Guangdong","date":"2024-05-03T01:44:00+00:00","carrier":2,"status":"Send to export customs"},{"location":"Guangzhou, Guangdong","date":"2024-05-03T01:44:00+00:00","carrier":2,"status":"Exported"},{"location":"Guangzhou, Guangdong","date":"2024-05-03T01:44:00+00:00","carrier":2,"status":"Export customs release"},{"location":"Guangzhou, Guangdong","date":"2024-05-02T23:05:00Z","carrier":1,"status":"Chegou ao centro de triagem e será logo separado."},{"location":"Guangzhou, Guangdong","date":"2024-05-02T23:05:00+00:00","carrier":2,"status":"Arrived at the sorting center and will be sorted soon"},{"location":"Dongguan, Guangdong","date":"2024-05-02T19:58:00Z","carrier":1,"status":"Departed from sorting center"},{"location":"Dongguan, Guangdong","date":"2024-05-02T19:58:00+00:00","carrier":2,"status":"Departed from sorting center"},{"location":"Dongguan, Guangdong","date":"2024-05-02T18:48:00Z","carrier":1,"status":"Chegou ao centro de triagem e será logo separado."},{"location":"Dongguan, Guangdong","date":"2024-05-02T18:48:00+00:00","carrier":2,"status":"Arrived at the sorting center and will be sorted soon"},{"location":"Dongguan, Guangdong","date":"2024-05-02T13:14:00Z","carrier":1,"status":"Export customs release"},{"location":"Dongguan, Guangdong","date":"2024-05-02T13:14:00Z","carrier":1,"status":"Sent to export customs"},{"location":"Dongguan, Guangdong","date":"2024-05-02T13:14:00+00:00","carrier":2,"status":"Export customs release"},{"location":"Dongguan, Guangdong","date":"2024-05-02T13:14:00+00:00","carrier":2,"status":"Send to export customs"},{"location":"Dongguan, Guangdong","date":"2024-05-01T19:17:00Z","carrier":1,"status":"Departed from sorting center"},{"location":"Dongguan, Guangdong","date":"2024-05-01T19:17:00Z","carrier":1,"status":"The package is being organized and is ready to be shipped."},{"location":"Dongguan, Guangdong","date":"2024-05-01T19:17:00Z","carrier":1,"status":"China Post has received the mail"},{"location":"Dongguan, Guangdong","date":"2024-05-01T19:17:00+00:00","carrier":2,"status":"Departed from sorting center"},{"location":"Dongguan, Guangdong","date":"2024-05-01T19:17:00+00:00","carrier":2,"status":"Shipment is being sorted and ready to be sent out"},{"location":"Dongguan, Guangdong","date":"2024-05-01T19:17:00+00:00","carrier":2,"status":"China Post has received the mail"},{"location":"Dongguan, Guangdong","date":"2024-05-01T02:39:00Z","carrier":1,"status":"Your package has been checked by EU Customs and sent for further processing."},{"location":"Dongguan, Guangdong","date":"2024-05-01T02:39:00+00:00","carrier":2,"status":"Your shipment has been reviewed by EU Customs and sent to the next step for processing."},{"location":"Dongguan, Guangdong","date":"2024-05-01T01:12:00Z","carrier":1,"status":"As per the regulations of EU customs, your mail is being pre-declared (starting from October 2, 2023, all air mail entering the EU must be pre-declared)."},{"location":"Dongguan, Guangdong","date":"2024-05-01T01:12:00+00:00","carrier":2,"status":"According to the requirements of EU customs, your mail is being pre-declared (from October 2, 2023, all air mail entering the EU must be pre-declared)"}],"origin":"China","destination":"Portugal","carriers":["4PX Express","Portugal Post - Portugal CTT","China Post"],"externalTracking":[{"slug":"portugal-post","url":"https://ctt.pt/t/LV997747362CN","method":"GET","title":"Portugal Post - Portugal CTT"},{"method":"GET","url":"http://yjcx.chinapost.com.cn/qps/english/yjcx","copy":true,"slug":"china-post","trackingId":"LV997747362CN","title":"China Post"}],"services":[{"slug":"4px","name":"4PX Express"},{"slug":"portugal-post","name":"Portugal Post - Portugal CTT"},{"slug":"china-post","name":"China Post"}],"detected":[1,2],"detectedCarrier":{"name":"China Post","slug":"china-post"},"carrier":{"slug":"china-post","name":"China Post"},"checkedCountry":"Portugal","checkedCountryCode":"PT","destinationCode":"PT","originCode":"CN","status":"transit","attributes":[{"l":"tracking_id","val":"LV997747362CN"},{"l":"origin","val":"China","code":"CN"},{"l":"destination","val":"Portugal","code":"PT"},{"l":"days_transit","n":"Days in transit","val":"21"}],"eta":{"period":["2024-05-27T00:00:00+00:00","2024-06-07T00:00:00+00:00"],"total":26,"min":17,"max":38,"remaining":[4,15],"parcels":34},"trackingId":"LV997747362CN","lastState":{"date":"2024-05-20T10:22:00Z","carrier":1,"status":"Overseas import customs clearance"}}],"done":true,"fromCache":true, "UUID":"dummyuuid123213"}`
)

type dummyStruct struct{}

func (d *dummyStruct) PostParcel(data *Request) ([]byte, error) {
	return []byte(validJson), nil
}

func TestGetParcel(t *testing.T) {
	dummyHandler := &dummyStruct{}
	ps := NewParcelService(dummyHandler)
	res, err := ps.GetParcel(&Request{})

	expectedUuid := "dummyuuid123213"
	if err != nil && res.UUID != expectedUuid {
		t.Fatalf("Parsed response and JSON mismatch expected '%s', but got '%s'", expectedUuid, res.UUID)
	}
}

func TestGetLatestParcelState(t *testing.T) {
	dummyHandler := &dummyStruct{}
	ps := NewParcelService(dummyHandler)
	res, err := ps.GetParcel(&Request{})

	expectedDate := "2024-05-20T10:22:00Z"
	if err != nil && res.Shipments[len(res.Shipments)-1].LastState.Date != expectedDate {
		t.Fatalf("Parsed last state date mismatch expected '%s', but got '%s'", expectedDate, res.UUID)
	}
}
